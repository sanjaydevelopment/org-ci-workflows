name: Python Checks

on:
  workflow_call:

permissions:
  contents: read
  issues: write

jobs:
  run-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Initialize results
        run: |
          echo "REQ_RESULT=success" >> $GITHUB_ENV
          echo "STRUCT_RESULT=success" >> $GITHUB_ENV
          echo "SECRET_RESULT=success" >> $GITHUB_ENV
          echo "LINT_RESULT=success" >> $GITHUB_ENV
          echo "SECURITY_RESULT=success" >> $GITHUB_ENV

      # ---------------- Mandatory Checks ----------------
      - name: Check for requirements.txt
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "REQ_RESULT=fail" >> $GITHUB_ENV
            echo "::error::âŒ Missing requirements.txt file"
            exit 1
          fi
          echo "âœ… Found requirements.txt"

      - name: Check project structure
        run: |
          if [ ! -d "src" ]; then
            echo "STRUCT_RESULT=fail" >> $GITHUB_ENV
            echo "::error::âŒ Missing src directory"
            exit 1
          fi
          echo "âœ… Found src directory"

      # ---------------- Optional Checks ----------------
      - name: Check for hardcoded sensitive values
        continue-on-error: true
        run: |
          if grep -r -i -E "(password|api_key|secret|token)" . --exclude-dir=.git 2>/dev/null | grep -v "node_modules"; then
            echo "SECRET_RESULT=fail" >> $GITHUB_ENV
            echo "::warning::âš ï¸ Potential sensitive values found in code"
          else
            echo "âœ… No sensitive values detected"
          fi

      - name: Run lint (flake8)
        continue-on-error: true
        run: |
          pip install flake8
          if ! flake8 . --exclude=.git; then
            echo "LINT_RESULT=fail" >> $GITHUB_ENV
            echo "::warning::âš ï¸ Lint issues found"
          else
            echo "âœ… Lint passed"
          fi

      - name: Run security check (bandit)
        continue-on-error: true
        run: |
          pip install bandit
          if ! bandit -r . --exclude=.git -f json -o bandit_output.json; then
            echo "SECURITY_RESULT=fail" >> $GITHUB_ENV
            echo "::warning::âš ï¸ Security issues found"
          else
            echo "âœ… Security check passed"
          fi

      # ---------------- Publish Summary ----------------
      - name: Publish summary
        if: always()
        run: |
          echo "## ðŸš¦ Python Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "$REQ_RESULT" = "success" ]; then echo "| requirements.txt | âœ… PASS |" >> $GITHUB_STEP_SUMMARY; else echo "| requirements.txt | âŒ FAIL |" >> $GITHUB_STEP_SUMMARY; fi
          if [ "$STRUCT_RESULT" = "success" ]; then echo "| Project structure | âœ… PASS |" >> $GITHUB_STEP_SUMMARY; else echo "| Project structure | âŒ FAIL |" >> $GITHUB_STEP_SUMMARY; fi
          if [ "$SECRET_RESULT" = "success" ]; then echo "| Sensitive values | âœ… PASS |" >> $GITHUB_STEP_SUMMARY; else echo "| Sensitive values | âš ï¸ WARNING |" >> $GITHUB_STEP_SUMMARY; fi
          if [ "$LINT_RESULT" = "success" ]; then echo "| Lint | âœ… PASS |" >> $GITHUB_STEP_SUMMARY; else echo "| Lint | âš ï¸ WARNING |" >> $GITHUB_STEP_SUMMARY; fi
          if [ "$SECURITY_RESULT" = "success" ]; then echo "| Security check | âœ… PASS |" >> $GITHUB_STEP_SUMMARY; else echo "| Security check | âš ï¸ WARNING |" >> $GITHUB_STEP_SUMMARY; fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          if [ "$REQ_RESULT" = "fail" ] || [ "$STRUCT_RESULT" = "fail" ]; then
            echo "- âŒ Fix mandatory checks first" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… All checks passed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ðŸ”— [View full workflow logs]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> $GITHUB_STEP_SUMMARY

      # ---------------- Fail Job if Mandatory Checks Fail ----------------
      - name: Fail job if mandatory checks failed
        if: always()
        run: |
          if [ "$REQ_RESULT" = "fail" ] || [ "$STRUCT_RESULT" = "fail" ]; then
            echo "âŒ Mandatory checks failed - blocking merge"
            exit 1
          fi
          echo "âœ… All mandatory checks passed"

      # ---------------- Check for failed checks ----------------
      - name: Check for failed checks
        if: always()
        id: check-failures
        run: |
          FAILED_CHECKS=""
          if [ "$REQ_RESULT" = "fail" ]; then FAILED_CHECKS="$FAILED_CHECKS requirements.txt,"; fi
          if [ "$STRUCT_RESULT" = "fail" ]; then FAILED_CHECKS="$FAILED_CHECKS project structure,"; fi
          if [ "$SECRET_RESULT" = "fail" ]; then FAILED_CHECKS="$FAILED_CHECKS sensitive values,"; fi
          if [ "$LINT_RESULT" = "fail" ]; then FAILED_CHECKS="$FAILED_CHECKS lint,"; fi
          if [ "$SECURITY_RESULT" = "fail" ]; then FAILED_CHECKS="$FAILED_CHECKS security,"; fi
          
          if [ -n "$FAILED_CHECKS" ]; then
            FAILED_CHECKS=${FAILED_CHECKS%,}
            echo "failed_checks=$FAILED_CHECKS" >> $GITHUB_OUTPUT
            echo "has_failures=true" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
          fi

      # ---------------- Create Developer Issue (in project repo) ----------------
      - name: Create Developer Issue
        if: always() && steps.check-failures.outputs.has_failures == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“ Creating developer issue in $GITHUB_REPOSITORY..."
          
          # Clean, formatted developer issue body
          REPO_ISSUE_BODY="### ðŸš¨ Python Quality Checks Failed

**Repository**: $GITHUB_REPOSITORY
**Branch**: $GITHUB_REF_NAME
**Commit**: [$GITHUB_SHA]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA)

#### âŒ Failed Checks
- **${{ steps.check-failures.outputs.failed_checks }}**

#### ðŸ“Š Check Results
| Check | Status |
|-------|--------|
| requirements.txt | $REQ_RESULT |
| Project Structure | $STRUCT_RESULT |
| Sensitive Values | $SECRET_RESULT |
| Code Style (Lint) | $LINT_RESULT |
| Security | $SECURITY_RESULT |

#### ðŸš¨ Action Required
1. **Review** the [workflow logs]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)
2. **Fix** the failed checks above
3. **Push** changes to re-run checks automatically

#### âš ï¸ Important
- **Mandatory checks** (requirements.txt, project structure) **must pass** before merging
- Optional checks (lint, security) should be fixed for code quality

---
*Auto-generated by Python Checks workflow on $(date)*"

          # Create developer issue
          REPO_ISSUE=$(gh issue create \
            --title "ðŸ” [${{ steps.check-failures.outputs.failed_checks }}] Python Quality Issues" \
            --body "$REPO_ISSUE_BODY" \
            --label "python-check-fail,bug,quality" \
            2>&1)
          
          if echo "$REPO_ISSUE" | grep -q "created"; then
            REPO_ISSUE_NUMBER=$(echo "$REPO_ISSUE" | grep -o '#[0-9]*' | head -1 | sed 's/#//')
            echo "âœ… Created developer issue #$REPO_ISSUE_NUMBER"
            echo "repo_issue_number=$REPO_ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "âŒ Developer issue creation failed!"
            echo "repo_issue_number=0" >> $GITHUB_OUTPUT
          fi
        id: create-dev-issue

      # ---------------- Create Leadership Issue (in central org repo) ----------------
      - name: Create Leadership Issue
        if: always() && steps.check-failures.outputs.has_failures == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ“Š Creating leadership issue in central org repo..."
          
          # Central repo for leadership issues - UPDATE THIS
          CENTRAL_REPO="sanjaydevelopment/Python-Quality-Issues"
          
          # Clean, executive-friendly leadership issue body
          ORG_ISSUE_BODY="### ðŸš¨ Python Quality Issue Detected

**Repository**: $GITHUB_REPOSITORY
**Branch**: $GITHUB_REF_NAME
**Commit**: [$GITHUB_SHA]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA)
**Workflow**: [$GITHUB_RUN_ID]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)

#### âŒ Failed Checks
${{ steps.check-failures.outputs.failed_checks }}

#### ðŸ“Š Status Summary
| Check | Result |
|-------|--------|
| requirements.txt | $REQ_RESULT |
| Project Structure | $STRUCT_RESULT |
| Sensitive Values | $SECRET_RESULT |
| Code Style (Lint) | $LINT_RESULT |
| Security | $SECURITY_RESULT |

#### ðŸŽ¯ Priority & Impact
"
          if [ "$REQ_RESULT" = "fail" ] || [ "$STRUCT_RESULT" = "fail" ]; then
            ORG_ISSUE_BODY="$ORG_ISSUE_BODY**ðŸš¨ HIGH PRIORITY** - Blocks deployment/merge
- **Impact**: Cannot deploy until fixed
- **Timeline**: Immediate (same day)"
          else
            ORG_ISSUE_BODY="$ORG_ISSUE_BODY**âš ï¸ MEDIUM PRIORITY** - Quality concerns
- **Impact**: Code quality and maintainability
- **Timeline**: Within 1 week"
          fi

          # Add developer issue link if created
          if [ "${{ steps.create-dev-issue.outputs.repo_issue_number }}" != "0" ]; then
            ORG_ISSUE_BODY="$ORG_ISSUE_BODY

#### ðŸ”— Developer Action
- **Repo Issue**: #${{ steps.create-dev-issue.outputs.repo_issue_number }} in $GITHUB_REPOSITORY"
          fi

          ORG_ISSUE_BODY="$ORG_ISSUE_BODY

#### ðŸ“ˆ Business Impact
- **Risk**: Potential security vulnerabilities or deployment failures
- **Cost**: Developer time to fix + potential production issues
- **ROI**: Early detection saves 5x the fix cost

---
*Auto-generated by Python Quality Gates - $(date)*"

          # Create leadership issue in central repo
          ORG_ISSUE=$(gh issue create \
            --repo "$CENTRAL_REPO" \
            --title "ðŸš¨ [$GITHUB_REPOSITORY] - ${{ steps.check-failures.outputs.failed_checks }}" \
            --body "$ORG_ISSUE_BODY" \
            --label "quality-issue,python,${GITHUB_REPOSITORY##*/}" \
            2>&1)
          
          if echo "$ORG_ISSUE" | grep -q "created"; then
            ORG_ISSUE_NUMBER=$(echo "$ORG_ISSUE" | grep -o '#[0-9]*' | head -1 | sed 's/#//')
            echo "âœ… Created leadership issue #$ORG_ISSUE_NUMBER in $CENTRAL_REPO"
          else
            echo "âŒ Leadership issue creation failed! Output: $ORG_ISSUE"
            echo "Falling back to same repo..."
            # Fallback: create in same repo if central repo doesn't exist
            gh issue create \
              --title "ðŸš¨ [$GITHUB_REPOSITORY] - ${{ steps.check-failures.outputs.failed_checks }} (FALLBACK)" \
              --body "$ORG_ISSUE_BODY" \
              --label "quality-issue,python,leadership" \
              2>&1
          fi

      # ---------------- Success Notification ----------------
      - name: Notify on Success
        if: always() && steps.check-failures.outputs.has_failures == 'false'
        run: |
          echo "ðŸŽ‰ All Python quality checks passed successfully!"
          echo "âœ… This commit is ready for review and merge."
