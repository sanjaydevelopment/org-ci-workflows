name: Global Python Checks

on:
  workflow_call:

permissions:
  contents: read
  issues: write   # ✅ required to create/update CI issues

jobs:
  run-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Initialize failure summary
        run: echo "" > failure-summary.txt

      # ✅ requirements.txt
      - name: Check for requirements.txt
        run: |
          if [ ! -f requirements.txt ]; then
            echo "❌ requirements.txt missing" >> failure-summary.txt
          else
            echo "✅ requirements.txt found" >> failure-summary.txt
          fi

      # ✅ Project structure (example: src + tests must exist)
      - name: Check project structure
        run: |
          for dir in src tests; do
            if [ ! -d "$dir" ]; then
              echo "❌ Missing directory: $dir" >> failure-summary.txt
            else
              echo "✅ Found directory: $dir" >> failure-summary.txt
            fi
          done

      # ✅ Hardcoded secrets
      - name: Check for hardcoded sensitive values
        run: |
          if grep -R -n -E "password=|api[_-]?key=|secret=" .; then
            echo "❌ Hardcoded sensitive values found" >> failure-summary.txt
          else
            echo "✅ No hardcoded sensitive values detected" >> failure-summary.txt
          fi

      # ✅ Lint
      - name: Run lint
        run: |
          pip install flake8
          set +e
          flake8 . > lint-report.txt
          if [ $? -ne 0 ]; then
            echo "❌ Lint errors found (see report below)" >> failure-summary.txt
          else
            echo "✅ No lint errors" >> failure-summary.txt
          fi
          set -e

      # ✅ Security check
      - name: Run security check
        run: |
          pip install bandit
          set +e
          bandit -r . -f txt -o security-report.txt
          if [ $? -ne 0 ]; then
            echo "❌ Security issues found (see report below)" >> failure-summary.txt
          else
            echo "✅ No security issues" >> failure-summary.txt
          fi
          set -e

      # ✅ Write results to GitHub UI summary
      - name: Publish summary
        run: |
          echo "## 📝 CI Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Overall Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat failure-summary.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f lint-report.txt ]; then
            echo "### 🔎 Lint Report" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat lint-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f security-report.txt ]; then
            echo "### 🔐 Security Report" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat security-report.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      # ✅ Check if failed
      - name: Check results
        id: results
        run: |
          if grep -q "❌" failure-summary.txt; then
            echo "status=fail" >> $GITHUB_OUTPUT
          else
            echo "status=pass" >> $GITHUB_OUTPUT
          fi

      # ✅ Manage Issue
      - name: Create/Update Issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const summary = fs.readFileSync("failure-summary.txt", "utf8");
            const branch = process.env.GITHUB_REF_NAME;
            const issueTitle = `⚠️ CI Issues in branch: ${branch}`;
            const label = "ci-checks";

            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "open",
                labels: label
              }
            );
            const existing = issues.find(i => i.title === issueTitle);

            if ("${{ steps.results.outputs.status }}" === "fail") {
              const body = `CI checks failed on branch \`${branch}\` in workflow run: [${context.runId}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n**Summary:**\n\`\`\`\n${summary}\n\`\`\``;

              if (existing) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existing.number,
                  body
                });
              } else {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body,
                  labels: [label]
                });
              }
            } else {
              if (existing) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existing.number,
                  state: "closed",
                  body: "✅ All checks passing, closing issue."
                });
              }
            }

      # ✅ Final fail if needed
      - name: Fail job if checks failed
        if: steps.results.outputs.status == 'fail'
        run: exit 1
