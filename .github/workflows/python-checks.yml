name: Python Checks

on:
  workflow_call:

permissions:
  contents: read
  issues: write

jobs:
  run-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Initialize results
        run: |
          echo "REQ_RESULT=success" >> $GITHUB_ENV
          echo "STRUCT_RESULT=success" >> $GITHUB_ENV
          echo "SECRET_RESULT=success" >> $GITHUB_ENV
          echo "LINT_RESULT=success" >> $GITHUB_ENV
          echo "SECURITY_RESULT=success" >> $GITHUB_ENV

      # ---------------- Mandatory Checks ----------------
      - name: Check for requirements.txt
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "REQ_RESULT=fail" >> $GITHUB_ENV
            echo "::error::❌ Missing requirements.txt file"
            exit 1
          fi
          echo "✅ Found requirements.txt"

      - name: Check project structure
        run: |
          if [ ! -d "src" ]; then
            echo "STRUCT_RESULT=fail" >> $GITHUB_ENV
            echo "::error::❌ Missing src directory"
            exit 1
          fi
          echo "✅ Found src directory"

      # ---------------- Optional Checks ----------------
      - name: Check for hardcoded sensitive values
        continue-on-error: true
        run: |
          if grep -r -i -E "(password|api_key|secret|token)" . --exclude-dir=.git 2>/dev/null | grep -v "node_modules"; then
            echo "SECRET_RESULT=fail" >> $GITHUB_ENV
            echo "::warning::⚠️ Potential sensitive values found in code"
          else
            echo "✅ No sensitive values detected"
          fi

      - name: Run lint (flake8)
        continue-on-error: true
        run: |
          pip install flake8
          if ! flake8 . --exclude=.git; then
            echo "LINT_RESULT=fail" >> $GITHUB_ENV
            echo "::warning::⚠️ Lint issues found"
          else
            echo "✅ Lint passed"
          fi

      - name: Run security check (bandit)
        continue-on-error: true
        run: |
          pip install bandit
          if ! bandit -r . --exclude=.git -f json -o bandit_output.json; then
            echo "SECURITY_RESULT=fail" >> $GITHUB_ENV
            echo "::warning::⚠️ Security issues found"
          else
            echo "✅ Security check passed"
          fi

      # ---------------- Publish Summary ----------------
      - name: Publish summary
        if: always()
        run: |
          echo "## 🚦 Python Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "$REQ_RESULT" = "success" ]; then echo "| requirements.txt | ✅ PASS |" >> $GITHUB_STEP_SUMMARY; else echo "| requirements.txt | ❌ FAIL |" >> $GITHUB_STEP_SUMMARY; fi
          if [ "$STRUCT_RESULT" = "success" ]; then echo "| Project structure | ✅ PASS |" >> $GITHUB_STEP_SUMMARY; else echo "| Project structure | ❌ FAIL |" >> $GITHUB_STEP_SUMMARY; fi
          if [ "$SECRET_RESULT" = "success" ]; then echo "| Sensitive values | ✅ PASS |" >> $GITHUB_STEP_SUMMARY; else echo "| Sensitive values | ⚠️ WARNING |" >> $GITHUB_STEP_SUMMARY; fi
          if [ "$LINT_RESULT" = "success" ]; then echo "| Lint | ✅ PASS |" >> $GITHUB_STEP_SUMMARY; else echo "| Lint | ⚠️ WARNING |" >> $GITHUB_STEP_SUMMARY; fi
          if [ "$SECURITY_RESULT" = "success" ]; then echo "| Security check | ✅ PASS |" >> $GITHUB_STEP_SUMMARY; else echo "| Security check | ⚠️ WARNING |" >> $GITHUB_STEP_SUMMARY; fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Next Steps" >> $GITHUB_STEP_SUMMARY
          if [ "$REQ_RESULT" = "fail" ] || [ "$STRUCT_RESULT" = "fail" ]; then
            echo "- ❌ Fix mandatory checks first" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ✅ All checks passed! 🎉" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- 🔗 [View full workflow logs]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" >> $GITHUB_STEP_SUMMARY

      # ---------------- Fail Job if Mandatory Checks Fail ----------------
      - name: Fail job if mandatory checks failed
        if: always()
        run: |
          if [ "$REQ_RESULT" = "fail" ] || [ "$STRUCT_RESULT" = "fail" ]; then
            echo "❌ Mandatory checks failed - blocking merge"
            exit 1
          fi
          echo "✅ All mandatory checks passed"

      # ---------------- Check for failed checks ----------------
      - name: Check for failed checks
        if: always()
        id: check-failures
        run: |
          FAILED_CHECKS=""
          if [ "$REQ_RESULT" = "fail" ]; then FAILED_CHECKS="$FAILED_CHECKS requirements.txt,"; fi
          if [ "$STRUCT_RESULT" = "fail" ]; then FAILED_CHECKS="$FAILED_CHECKS project structure,"; fi
          if [ "$SECRET_RESULT" = "fail" ]; then FAILED_CHECKS="$FAILED_CHECKS sensitive values,"; fi
          if [ "$LINT_RESULT" = "fail" ]; then FAILED_CHECKS="$FAILED_CHECKS lint,"; fi
          if [ "$SECURITY_RESULT" = "fail" ]; then FAILED_CHECKS="$FAILED_CHECKS security,"; fi
          
          if [ -n "$FAILED_CHECKS" ]; then
            FAILED_CHECKS=${FAILED_CHECKS%,}
            echo "failed_checks=$FAILED_CHECKS" >> $GITHUB_OUTPUT
            echo "has_failures=true" >> $GITHUB_OUTPUT
            echo "❌ Failed checks detected: $FAILED_CHECKS"
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "✅ All checks passed!"
          fi

      # ---------------- Create Developer Issue (in project repo) - DEBUG VERSION ----------------
      - name: Create Developer Issue
        if: always() && steps.check-failures.outputs.has_failures == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== DEBUG: Starting Developer Issue Creation ==="
          echo "DEBUG: Current repo = $GITHUB_REPOSITORY"
          echo "DEBUG: Failed checks = ${{ steps.check-failures.outputs.failed_checks }}"
          echo "DEBUG: GH_TOKEN length = ${#GH_TOKEN}"
          
          # Test gh auth
          echo "DEBUG: Testing gh auth..."
          gh auth status || echo "ERROR: gh auth failed"
          
          # Test gh repo view
          echo "DEBUG: Testing repo access..."
          gh repo view $GITHUB_REPOSITORY || echo "ERROR: Cannot access repo"
          
          # Test creating simple issue without labels first
          echo "DEBUG: Creating simple test issue..."
          TEST_ISSUE=$(gh issue create \
            --title "TEST: Simple issue creation test" \
            --body "This is a test issue to verify gh CLI works" \
            2>&1 || echo "TEST FAILED: $?")
          
          echo "DEBUG: Test issue output: $TEST_ISSUE"
          
          # If test works, create real developer issue
          if echo "$TEST_ISSUE" | grep -q "created"; then
            echo "✅ Test issue created successfully!"
            
            # Clean up test issue
            TEST_NUMBER=$(echo "$TEST_ISSUE" | grep -o '#[0-9]*' | head -1 | sed 's/#//')
            gh issue close $TEST_NUMBER || echo "Cleanup failed, ignore"
            
            # Now create real developer issue
            FAILED_CHECKS="${{ steps.check-failures.outputs.failed_checks }}"
            echo "DEBUG: Creating real developer issue..."
            
            REPO_ISSUE_BODY="### 🚨 Python Quality Checks Failed\n\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY**Repository**: $GITHUB_REPOSITORY\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY**Branch**: $GITHUB_REF_NAME\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY**Commit**: [$GITHUB_SHA]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA)\n\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY#### ❌ Failed Checks\n- **$FAILED_CHECKS**\n\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY#### 📊 Check Results\n| Check | Status |\n|-------|--------|\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY| requirements.txt | $REQ_RESULT |\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY| Project Structure | $STRUCT_RESULT |\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY| Sensitive Values | $SECRET_RESULT |\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY| Code Style (Lint) | $LINT_RESULT |\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY| Security | $SECURITY_RESULT |\n\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY#### 🚨 Action Required\n1. **Review** the [workflow logs]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY2. **Fix** the failed checks above\n3. **Push** changes to re-run checks automatically\n\n"
            REPO_ISSUE_BODY="$REPO_ISSUE_BODY#### ⚠️ Important\n- **Mandatory checks** must pass before merging\n\n---\n*Auto-generated by Python Checks*"
            
            REPO_ISSUE=$(gh issue create \
              --title "🔍 [$FAILED_CHECKS] Python Quality Issues" \
              --body "$REPO_ISSUE_BODY" \
              2>&1)
            
            echo "DEBUG: Developer issue output: $REPO_ISSUE"
            
            if echo "$REPO_ISSUE" | grep -q "created"; then
              REPO_ISSUE_NUMBER=$(echo "$REPO_ISSUE" | grep -o '#[0-9]*' | head -1 | sed 's/#//')
              echo "✅ Created developer issue #$REPO_ISSUE_NUMBER"
              echo "repo_issue_number=$REPO_ISSUE_NUMBER" >> $GITHUB_OUTPUT
            else
              echo "❌ Developer issue creation failed!"
              echo "repo_issue_number=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "❌ Even simple test issue failed! Check permissions and token."
            echo "repo_issue_number=0" >> $GITHUB_OUTPUT
          fi
        id: create-dev-issue

      # ---------------- Create Leadership Issue (in central org repo) - DEBUG VERSION ----------------
      - name: Create Leadership Issue
        if: always() && steps.check-failures.outputs.has_failures == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== DEBUG: Starting Leadership Issue Creation ==="
          echo "DEBUG: Failed checks = ${{ steps.check-failures.outputs.failed_checks }}"
          echo "DEBUG: Repo issue number = ${{ steps.create-dev-issue.outputs.repo_issue_number }}"
          
          # Central repo for leadership issues
          CENTRAL_REPO="sanjaydevelopment/Python-Quality-Issues"
          echo "DEBUG: Central repo = $CENTRAL_REPO"
          
          # Test if central repo exists
          echo "DEBUG: Testing central repo access..."
          gh repo view $CENTRAL_REPO 2>&1 || echo "ERROR: Central repo doesn't exist or no access"
          
          # For now, let's create leadership issue in the SAME repo to test
          echo "DEBUG: Creating leadership issue in SAME repo for testing..."
          FAILED_CHECKS="${{ steps.check-failures.outputs.failed_checks }}"
          REPO_ISSUE_NUMBER="${{ steps.create-dev-issue.outputs.repo_issue_number }}"
          
          ORG_ISSUE_BODY="### 🚨 Python Quality Issue (LEADERSHIP VIEW)\n\n"
          ORG_ISSUE_BODY="$ORG_ISSUE_BODY**Repository**: $GITHUB_REPOSITORY\n"
          ORG_ISSUE_BODY="$ORG_ISSUE_BODY**Failed**: $FAILED_CHECKS\n\n"
          ORG_ISSUE_BODY="$ORG_ISSUE_BODY#### 📊 Status\n"
          ORG_ISSUE_BODY="$ORG_ISSUE_BODY| Check | Result |\n|-------|--------|\n"
          ORG_ISSUE_BODY="$ORG_ISSUE_BODY| requirements.txt | $REQ_RESULT |\n"
          ORG_ISSUE_BODY="$ORG_ISSUE_BODY| Project Structure | $STRUCT_RESULT |\n"
          ORG_ISSUE_BODY="$ORG_ISSUE_BODY| Sensitive Values | $SECRET_RESULT |\n"
          ORG_ISSUE_BODY="$ORG_ISSUE_BODY| Lint | $LINT_RESULT |\n"
          ORG_ISSUE_BODY="$ORG_ISSUE_BODY| Security | $SECURITY_RESULT |\n\n"
          
          if [ "$REQ_RESULT" = "fail" ] || [ "$STRUCT_RESULT" = "fail" ]; then
            ORG_ISSUE_BODY="$ORG_ISSUE_BODY**🚨 HIGH** - Blocks merge\n"
          else
            ORG_ISSUE_BODY="$ORG_ISSUE_BODY**⚠️ MEDIUM** - Quality issue\n"
          fi
          
          if [ "$REPO_ISSUE_NUMBER" != "0" ]; then
            ORG_ISSUE_BODY="$ORG_ISSUE_BODY\n**Developer Issue**: #$REPO_ISSUE_NUMBER"
          fi
          
          ORG_ISSUE_BODY="$ORG_ISSUE_BODY\n\n---\n*Auto-generated for leadership dashboard*"
          
          # Create leadership issue in same repo for testing
          ORG_ISSUE=$(gh issue create \
            --title "🚨 [$GITHUB_REPOSITORY] $FAILED_CHECKS - LEADERSHIP" \
            --body "$ORG_ISSUE_BODY" \
            2>&1)
          
          echo "DEBUG: Leadership issue output: $ORG_ISSUE"
          
          if echo "$ORG_ISSUE" | grep -q "created"; then
            ORG_ISSUE_NUMBER=$(echo "$ORG_ISSUE" | grep -o '#[0-9]*' | head -1 | sed 's/#//')
            echo "✅ Created leadership issue #$ORG_ISSUE_NUMBER"
          else
            echo "❌ Leadership issue creation failed!"
          fi

      # ---------------- Success Notification ----------------
      - name: Notify on Success
        if: always() && steps.check-failures.outputs.has_failures == 'false'
        run: |
          echo "🎉 All Python quality checks passed successfully!"
          echo "✅ This commit is ready for review and merge."
